"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const g=require("react/jsx-runtime"),T=require("@react-three/fiber"),F=require("@react-three/postprocessing"),b=require("postprocessing"),t=require("react"),D=require("three"),L=require("@takram/three-geospatial"),a=require("./shared.cjs"),j=require("@react-three/drei"),M=t.createContext({}),A=({ref:r,textures:e,ellipsoid:i=L.Ellipsoid.WGS84,correctAltitude:s=!0,ground:n=!0,date:u,children:c})=>{const p=t.useRef({sunDirection:new D.Vector3,moonDirection:new D.Vector3,worldToECEFMatrix:new D.Matrix4,inertialToECEFMatrix:new D.Matrix4,overlay:null,shadow:null,shadowLength:null,lightingMask:null}),l=T.useThree(({gl:m})=>m),f=t.useMemo(()=>typeof e=="string"?new a.PrecomputedTexturesLoader().setType(l).load(e):void 0,[e,l]);t.useEffect(()=>{if(f!=null)return()=>{for(const m of Object.values(f))m==null||m.dispose()}},[f]);const d=t.useMemo(()=>e==null?new a.PrecomputedTexturesGenerator(l):void 0,[e,l]);t.useEffect(()=>{if(d!=null)return d.update().catch(m=>{console.error(m)}),()=>{d.dispose()}},[d]);const h=(d==null?void 0:d.textures)??(typeof e=="string"?f:e),E=t.useMemo(()=>({textures:h,ellipsoid:i,correctAltitude:s,ground:n,transientStates:p.current}),[h,i,s,n]),o=t.useMemo(()=>{const{sunDirection:m,moonDirection:S,inertialToECEFMatrix:C}=p.current;return y=>{a.getECIToECEFRotationMatrix(y,C),a.getSunDirectionECI(y,m).applyMatrix4(C),a.getMoonDirectionECI(y,S).applyMatrix4(C)}},[]),x=u!=null&&!isNaN(+u)?+u:void 0;return t.useEffect(()=>{x!=null&&o(x)},[x,o]),t.useImperativeHandle(r,()=>({...p.current,textures:h,updateByDate:o}),[h,o]),g.jsx(M.Provider,{value:E,children:c})};function R(r){const{irradianceTexture:e,scatteringTexture:i,transmittanceTexture:s,singleMieScatteringTexture:n,higherOrderScatteringTexture:u,ellipsoid:c,correctAltitude:p,sunDirection:l,sunAngularRadius:f,ground:d,renderTargetCount:h,...E}=r;return[{irradianceTexture:e,scatteringTexture:i,transmittanceTexture:s,singleMieScatteringTexture:n,higherOrderScatteringTexture:u,ellipsoid:c,correctAltitude:p,sunDirection:l,sunAngularRadius:f,ground:d,renderTargetCount:h},E]}function _(r){const e=t.useMemo(()=>typeof r=="string"?new L.STBNLoader().load(r):void 0,[r]);return t.useEffect(()=>{if(e!=null)return()=>{e.dispose()}},[e]),(typeof r=="string"?e:r)??null}const N=({ref:r,stbnTexture:e=L.DEFAULT_STBN_URL,...i})=>{const{textures:s,transientStates:n,...u}=t.useContext(M),[c,{blendFunction:p,...l}]=R({...a.aerialPerspectiveEffectOptionsDefaults,...u,...s,...i}),f=t.useContext(F.EffectComposerContext),{normalPass:d,camera:h}=f,E="geometryPass"in f&&f.geometryPass instanceof b.RenderPass&&"geometryTexture"in f.geometryPass&&f.geometryPass.geometryTexture instanceof D.Texture?f.geometryPass.geometryTexture:void 0,o=t.useMemo(()=>new a.AerialPerspectiveEffect(void 0,{blendFunction:p}),[p]);t.useEffect(()=>()=>{o.dispose()},[o]);const[x,m]=t.useState(!1);T.useFrame(()=>{n!=null&&(o.sunDirection.copy(n.sunDirection),o.moonDirection.copy(n.moonDirection),o.worldToECEFMatrix.copy(n.worldToECEFMatrix),o.overlay=n.overlay,o.shadow=n.shadow,o.shadowLength=n.shadowLength,o.lightingMask=n.lightingMask,!x&&o.shadow!=null&&m(!0))});const S=_(x?e:void 0);return g.jsx("primitive",{ref:r,object:o,mainCamera:h,normalBuffer:E??(d==null?void 0:d.texture)??null,...c,...l,stbnTexture:S,octEncodedNormal:E!=null})};function O(r){return e=>{for(const i of r)v(i,e)}}function q(r){return e=>{const i=[];for(const s of r){const n=v(s,e),u=typeof n=="function";i.push(u?n:()=>v(s,null))}return()=>{for(const s of i)s()}}}function v(r,e){if(typeof r=="function")return r(e);r&&(r.current=e)}var P=parseInt(t.version.split(".")[0],10)>=19?q:O;const k=({ref:r,...e})=>{const{transientStates:i}=t.useContext(M),s=t.useCallback(c=>{if(c!=null&&i!=null)return i.lightingMask={map:c.texture,channel:"r"},()=>{i.lightingMask=null}},[i]),{scene:n,camera:u}=t.useContext(F.EffectComposerContext);return T.extend({LightingMaskPass:a.LightingMaskPass}),g.jsx("lightingMaskPass",{ref:P([s,r]),...e,args:[n,u]})},B=k,U=({ref:r,...e})=>{const{textures:i,transientStates:s,...n}=t.useContext(M),[u,{sun:c,moon:p,moonDirection:l,moonAngularRadius:f,lunarRadianceScale:d,groundAlbedo:h,...E}]=R({...a.skyMaterialParametersDefaults,...n,...i,...e}),o=t.useMemo(()=>new a.SkyMaterial,[]);return t.useEffect(()=>()=>{o.dispose()},[o]),T.useFrame(()=>{s!=null&&(o.sunDirection.copy(s.sunDirection),o.moonDirection.copy(s.moonDirection),o.worldToECEFMatrix.copy(s.worldToECEFMatrix),o.shadowLength=s.shadowLength)}),g.jsx(j.ScreenQuad,{renderOrder:a.SKY_RENDER_ORDER,...E,ref:r,children:g.jsx("primitive",{object:o,...u,sun:c,moon:p,moonDirection:l,moonAngularRadius:f,lunarRadianceScale:d,groundAlbedo:h})})},I=({ref:r,...e})=>{const{textures:i,transientStates:s,...n}=t.useContext(M),u=t.useRef(null);return T.useFrame(()=>{const c=u.current;c!=null&&s!=null&&(c.sunDirection.copy(s.sunDirection),c.worldToECEFMatrix.copy(s.worldToECEFMatrix),c.update())}),T.extend({SkyLightProbe:a.SkyLightProbe}),g.jsx("skyLightProbe",{ref:P([u,r]),...a.skyLightProbeParametersDefaults,...n,...i,...e})},G=({ref:r,data:e=a.DEFAULT_STARS_DATA_URL,...i})=>{const{textures:s,transientStates:n,...u}=t.useContext(M),[c,{pointSize:p,radianceScale:l,intensity:f,background:d,...h}]=R({...a.starsMaterialParametersDefaults,...u,...s,...i}),[E,o]=t.useState(typeof e!="string"?e:void 0);t.useEffect(()=>{if(typeof e=="string"){const y=new L.ArrayBufferLoader;(async()=>{o(await y.loadAsync(e))})().catch(w=>{console.error(w)})}else o(e)},[e]);const x=t.useMemo(()=>E!=null?new a.StarsGeometry(E):void 0,[E]);t.useEffect(()=>()=>{x==null||x.dispose()},[x]);const m=t.useMemo(()=>new a.StarsMaterial,[]);t.useEffect(()=>()=>{m.dispose()},[m]);const S=t.useRef(null);T.useFrame(({camera:y})=>{var w;n!=null&&y.isPerspectiveCamera===!0&&(m.sunDirection.copy(n.sunDirection),(w=S.current)==null||w.setRotationFromMatrix(n.inertialToECEFMatrix),m.worldToECEFMatrix.copy(n.worldToECEFMatrix))});const C=T.useThree(({camera:y})=>y);return x==null||C.isPerspectiveCamera!==!0?null:g.jsxs("points",{ref:P([S,r]),frustumCulled:!1,renderOrder:a.SKY_RENDER_ORDER+1,...h,children:[g.jsx("primitive",{object:x}),g.jsx("primitive",{object:m,...c,pointSize:p,radianceScale:l,intensity:f,background:d,depthTest:!0,depthWrite:!1})]})},K=({ref:r,position:e,...i})=>{const{textures:s,transientStates:n,...u}=t.useContext(M),c=t.useRef(null);T.useFrame(()=>{const l=c.current;l!=null&&n!=null&&(l.sunDirection.copy(n.sunDirection),l.worldToECEFMatrix.copy(n.worldToECEFMatrix),l.update())});const p=t.useMemo(()=>new D.Object3D,[]);return T.extend({SunDirectionalLight:a.SunDirectionalLight}),g.jsxs(g.Fragment,{children:[g.jsx("sunDirectionalLight",{ref:P([c,r]),...a.sunDirectionalLightParametersDefaults,...u,...s,...i,target:p}),g.jsx("primitive",{object:p,position:e})]})},V=new a.PrecomputedTexturesLoader;function W(r=a.DEFAULT_PRECOMPUTED_TEXTURES_URL){const e=T.useThree(({gl:s})=>s);return{textures:T.useLoader(V.setType(e),r)}}exports.AerialPerspective=N;exports.Atmosphere=A;exports.AtmosphereContext=M;exports.IrradianceMask=B;exports.LightingMask=k;exports.Sky=U;exports.SkyLight=I;exports.Stars=G;exports.SunLight=K;exports.separateProps=R;exports.useAtmosphereTextureProps=W;
//# sourceMappingURL=r3f.cjs.map
